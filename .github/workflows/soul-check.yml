name: VATA Soul Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install libcst

      - name: Scan Python files (robust - skip invalids)
        run: |
          echo "Scanning with robust mode (skips parse fails)"

          problems=()
          exit_code=0

          files=$(find . -type f \( -name "*.py" -o -name "*.PY" \) \
            ! -path "*/__pycache__/*" ! -path "./.git/*" ! -path "./.pytest_cache/*" || true)

          for f in $files; do
            echo ""
            echo "=== $f ==="

            if [ ! -s "$f" ]; then
              echo "SKIP: empty file"
              continue
            fi

            output=$(python vatahumanizer.py "$f" --level medium --target 40 2>&1 || echo "CRASH")

            echo "$output" | head -n 30   # limit log spam

            if echo "$output" | grep -qi "REJECTED"; then
              problems+=("$f → risky")
            fi

            score=$(echo "$output" | grep -oP 'SOUL SCORE: \K\d+' || echo "0")
            if (( score < 40 )); then
              problems+=("$f → low soul ($score)")
              exit_code=1
            fi

            if echo "$output" | grep -qi "ParserSyntaxError"; then
              echo "WARN: parse failed - likely stub"
            fi
          done

          if [ ${#problems[@]} -gt 0 ]; then
            echo "Issues:"
            printf ' - %s\n' "${problems[@]}"
            exit $exit_code
          else
            echo "All valid files OK"
          fi
