name: VATA Soul Debug Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  soul-debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install libcst
        run: pip install libcst

      - name: Check script
        run: |
          ls vatahumanizer.py
          python vatahumanizer.py --help

      - name: Scan ALL .py files (debug mode - lenient)
        run: |
          echo "DEBUG MODE: Low threshold, no hard guardian block"

          problems=()
          exit_code=0

          files=$(find . -type f \( -name "*.py" -o -name "*.PY" \) \
            ! -path "*/__pycache__/*" ! -path "./.git/*" ! -path "./.pytest_cache/*" || true)

          echo "Scanning files:"
          echo "$files" | sed 's/^/ - /'

          for f in $files; do
            echo ""
            echo "=== $f ==="
            output=$(python vatahumanizer.py "$f" --level medium --target 30 2>&1 || echo "CRASH: exit $?")
            echo "$output"

            if echo "$output" | grep -qiE "REJECTED|violations|dangerous"; then
              problems+=("$f → risky pattern warning (but not failing build)")
            fi

            score_raw=$(echo "$output" | grep -i "SOUL SCORE" | grep -o '[0-9]\+' | head -1 || echo "0")
            score=${score_raw:-0}
            echo "Parsed score: $score"

            if (( score < 30 )); then
              problems+=("$f → low soul ($score < 30)")
              exit_code=1
            fi
          done

          echo ""
          echo "=== SUMMARY ==="
          if [ ${#problems[@]} -eq 0 ]; then
            echo "GREEN: Everything passes (lenient mode)"
          else
            echo "ISSUES FOUND (${#problems[@]}):"
            for p in "${problems[@]}"; do echo " - $p"; done
            echo "(build fails due to low soul on some files - see above)"
            exit $exit_code
          fi
