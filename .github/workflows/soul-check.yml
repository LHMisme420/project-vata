name: VATA Soul & Guardian Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  soul-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install required packages
        run: |
          python -m pip install --upgrade pip
          pip install libcst

      - name: Verify humanizer script exists and runs
        run: python vatahumanizer.py --help

      - name: Run soul & guardian checks on all .py files
        run: |
          set -e  # exit on any error

          echo "Starting VATA Soul & Guardian checks..."

          EXIT_CODE=0
          FAILED_FILES=()

          # Find all .py files, exclude git and caches
          PY_FILES=$(find . -type f -name "*.py" ! -path "./.git/*" ! -path "*/__pycache__/*" ! -path "./.pytest_cache/*" || true)

          if [ -z "$PY_FILES" ]; then
            echo "No .py files found to check. All good."
            exit 0
          fi

          for file in $PY_FILES; do
            echo ""
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            echo "Checking: $file"
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

            # Run humanizer in check mode (non-modifying)
            # Use --target 50 --level medium; adjust as needed
            OUTPUT=$(python vatahumanizer.py "$file" --level medium --target 50 --block-risky 2>&1 || true)

            echo "$OUTPUT"
            echo ""

            # Check for guardian rejection
            if echo "$OUTPUT" | grep -qi "REJECTED\|violations found"; then
              echo "‚ùå GUARDIAN BLOCK: Risky code detected in $file"
              FAILED_FILES+=("$file (guardian block)")
              EXIT_CODE=1
              continue
            fi

            # Extract score more robustly (handles variations in output)
            SCORE_LINE=$(echo "$OUTPUT" | grep -i "SOUL SCORE:" | tail -1 || true)
            SCORE=$(echo "$SCORE_LINE" | grep -o '[0-9]\+' | head -1 || echo "0")

            if [ "$SCORE" -eq 0 ] && [ -n "$SCORE_LINE" ]; then
              echo "Warning: Score extraction failed - assuming low soul"
              SCORE=0
            fi

            echo "Extracted soul score: $SCORE/100"

            if [ "$SCORE" -lt 50 ]; then
              echo "‚ùå LOW SOUL ($SCORE < 50) in $file"
              FAILED_FILES+=("$file (soul $SCORE)")
              EXIT_CODE=1
            else
              echo "‚úÖ Passed ($SCORE)"
            fi
          done

          echo ""
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          if [ $EXIT_CODE -eq 0 ]; then
            echo "ALL FILES PASSED SOUL & GUARDIAN CHECK üî•"
          else
            echo "FAILURE SUMMARY:"
            printf ' - %s\n' "${FAILED_FILES[@]}"
            echo ""
            echo "Fix the failing files and push again."
            exit 1
          fi
